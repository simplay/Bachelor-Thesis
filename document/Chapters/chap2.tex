\section{Theoretical Background}
Explain that this thesis has deep theoretical background, some derivations
show derivation roadmap
\subsection{The Effect Of Diffraction}

\subsection{BRDF - Spectral Rendering}

\subsection{Stams derivation}

In his Paper Diffraction Shader, Jos Stam derives a an BRDF modeling the effect of diffraction for various analytical anistropic reflaction models using the scalar Kirchof theory and the theory of random processes. By emplyong the so called wave theory of diffraction [source 5 in stams paper] in which a wave is assumed to be a complex valued scalar. It's noteworthy, that stam's BRDF formulation does not take into account the polarization of the light. Nevertheless, light sources like sunlight and light bulbs are unpilarizaed. In our simulations we will always assume we have given i directional light source, i.e. sunlight. Hence, we can use stam's model for our derivations

A further assumption in Stam's Paper is, the emanated waves from the source are stationary - sunlight once again.
Which implies the wave is a superposition of independent monochromatic waves. This implies that each wave is associated to a definite wavelangth lambda.

Mention Helmolth equation, which has the solution $k = \frac{2\pi}{\lambda}$ which is the wavenumber

Stams starts his derviations by above's assumptions and by applying the Kirchhoff integral, which descirbes the reflected field and the Huygen's principle, which states, when somebody knows the wavefront at a given moment, the wave at a later time can be deducted by considering each point on the first wave as the source of a new disturbance.

\begin{equation}
  \psi_2 = \frac{i k e^{i K R}}{4 \pi R}(F\mathbf{v}-\mathbf{p}) \cdot \int_{S} \hat{\mathbf{n}} e^{ik\mathbf{v} \cdot \mathbf{s} d\mathbf{s}}
\end{equation}


In optics, when dealing with scattered waves, one does use differential scattering cross-section rather than a BRDF which has the following identitiy: 

\begin{equation}
    \sigma^0 = 4 \pi \lim_{R \to \infty} R^2 \frac{\langle \left|\psi_2\right|^2\rangle}{\langle \left|\psi_1\right|^2\rangle}
\end{equation}

Relationship between the BRDF and the scattering cross section is the follwing:

\begin{equation}
    BRDF = \frac{1}{4\pi}\frac{1}{A}\frac{\sigma^0}{cos(\theta_1)cos(\theta_2)}
\end{equation}

Wheras $\theta_1a$ and $\theta_2$ are the angles that the vectors $\hat{k_1}$
and $\hat{k_2}$ make with the vertical direction.
 
ADD FIGURE for k1, k2

where R is the disance from the center of the patch to the receiving point $x_p$, $\hat{\mathbf{n}}$ is the normal of the surface at s and the vectors:

\begin{equation*}
    \mathbf{v} = \hat{\mathbf{k_1}} - \hat{\mathbf{k_1}}
               = (u,v,w)
\end{equation*}

\begin{equation*}
    \mathbf{p} = \hat{\mathbf{k_1}} + \hat{\mathbf{k_1}}
\end{equation*}

During his derivations, Stam provides a analytical representation for the Kirchhoff integral by using his assumptions. He restricts himself to the reflaction of waves from height fields $h(x,y)$ with the assumption that the surface is defined as an elevation over the (x,y) plane using the surface plane approximation.
Which will lead him to the follwoing identity for the Kirchhoff integral

\begin{equation}
    \mathbf{I}(ku, kv) = \int \int \frac{1}{ikw}(-p_x, -p_y, ikwp) 
\end{equation}

wheras 

\begin{equation}
    p(x,y) = e^{ikwh(x,y)}
\end{equation}

We the observation that the integral is a Fourier transform by $-iku$ and $-ikv$
which will lead us to his final derivation, using the identity of BRDF, and computing the limes:

\begin{equation}
    BRDF = \frac{k^2 F^2 G}{4\pi^2 A w^2} \langle \left|P(ku, kv)\right|^2\rangle
\end{equation}

Where 

\begin{equation}
    G = \frac{(1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{cos(\theta_1)cos(\theta_2)}
\end{equation}

and P(x,y) is the Fourier transform of the function p(x,y) from above.

This identitiy for the BRDF is the starting point for our derivations.
 
\subsection{Taylor Series Approximation}

Based on J. Stam's Paper about Diffraction shaders we will show that
there is an approximation of his equation (5), \textbf{p(x,y)}, for
a explicitly given heightfield \textbf{h(x,y)}. This approximation
is achieved by using Taylor-Series and using this identity we will
further be able to approximate the Fourier-Transformation of p(x,y),
denoted as \textbf{P(u,v)}. Finally we will give an error bound for
this approximation.

\subsubsection{Taylor Series of p}

Given $p(x,y)=e^{ikwh(x,y)}$form Stam's Paper where h(x,y) is here
a given heightfield. Also given the definition $e^{y}=1+y+\frac{y^{2}}{2!}+\frac{y^{3}}{3!}+...=\sum_{n=0}^{\infty}\frac{y^{n}}{n!}$where
y can be real or even complex valued - note this identity can either
be derieved by power series or by Taylor-Series(using the derivatives
of the exp-function and developing the Taylor-Series around the point
a=0). Let us now set $y=ikwh(x,y)$where $i$ is the imaginary number.
For simplification, let us denote h(x,y) as h. It follows by our previous
stated identities: $e^{y}=1+(ikwh)+\frac{1}{2!}(ikwh)^{2}+\frac{1}{3!}(ikwh)^{3}+...=\sum_{n=0}^{\infty}\frac{(ikwh)^{n}}{n!}$.
Hence it holds $p(x,y)=\sum_{n=0}^{\infty}\frac{(ikwh(x,y))^{n}}{n!}.$


\subsubsection{Fourier Transformation of function p}

Let us now compute the Fourier Transformation of p(x,y) form above:$\mathcal{F}\left\{ p\right\} (u,v)=\mathcal{F}\left\{ \sum_{n=0}^{\infty}\frac{(ikwh(x,y))^{n}}{n!}.\right\} =^{\mathcal{F}\, lin\, Operator}\sum_{n=0}^{\infty}\mathcal{F}\left\{ \frac{(ikwh(x,y))^{n}}{n!}\right\} =\sum_{n=0}^{\infty}\frac{(ikwh)^{n}}{n!}\mathcal{F}\left\{ h(x,y){}^{n}\right\} $.
Hence it follows: $P(\alpha,\beta)=\sum_{n=0}^{\infty}\frac{(ikwh)^{n}}{n!}\mathcal{F}\left\{ h{}^{n}\right\} (\alpha,\beta)$.

\textbf{NB}: $\mathcal{F}\left\{ h{}^{n}\right\} (u,v)$ denotes the
two dimensional Fourier Transformation of p(x,y) and can be nummerically
computed by the two dimensional \textbf{DFT} or rather by the two
dimensional \textbf{FFT} over h(x,y). 


\subsubsection{Approximation of function P}

Next we are going to look for an $N\mathbb{\in N}$s.t. $\sum_{n=0}^{N}\frac{(ikwh)^{n}}{n!}\mathcal{F}\left\{ h{}^{n}\right\} (\alpha,\beta)\approx P(\alpha,\beta)$.
is a good approximation. We have to prove two things:
\begin{enumerate}
\item Show that there exist such an $N\mathbb{\in N}$s.t the approximation
holds true.
\item Find a value for B s.t. this approximation is below a certain error
bound, for example machine precision $\epsilon$. 
\end{enumerate}

\subsubsection{Proof Sketch of 1.}

By the \textbf{ratio test} (see \textbf{{[}1{]}}) we can show that
the series $\sum_{n=0}^{N}\frac{(ikwh)^{n}}{n!}\mathcal{F}\left\{ h{}^{n}\right\} (\alpha,\beta)$
converges absolutely:

\textbf{Proof}: Consider $\sum_{k=0}^{\infty}\frac{y^{n}}{n!}$where
$a_{k}=\frac{y^{k}}{k!}$. By the definition of the ratio test for
series it follows: $\forall y:$$limsup_{k\rightarrow\infty}|\frac{a_{k+1}}{a_{k}}|=limsup_{k\rightarrow\infty}\frac{y}{k+1}=0$ 

Thus this series converges absolutely, no matter what value we will
pick for y.


\subsubsection{Part 2: Find such an N}

Let $f(x)=e^{x}$. We can formulate its Taylor-Series, stated above.
Let $P_{n}(x)$denote the n-th Taylor-Polinomial, $P_{n}(x)=\sum_{k=0}^{n}\frac{f^{(k)}(a)}{k!}(x-a)^{k},$where
a is our developing point (here, in this case a=0). We can define
the error of the n-th Taylor-Polinomial to be $E_{n}(x)=f(x)-P_{n}(x)$.
That error is the actual value minus the Taylor polinomial. It holds
true: $|E_{n}(x)|=|f(x)-P_{n}(x)|$. By using the Lagrangien Error
Bound - (see source \textbf{{[}2{]}}) it follows: $|E_{n}(x)|\leq\frac{M}{(n+1)!}|x-a|^{n+1}$
with a=0, where \textbf{M }is some value satisfying $|f^{(n+1)}(x)|\leq M$
on the interval $I=[a,x]$.Since we are interested in an upper bound
of the error and since \textbf{a} is known, we can reformulate the
interval as $I=[0,x_{max}]$, where $x_{max}=|i|*k_{max}*w_{max}*h_{max}$,
since we are interested in computing an error bound for $e^{ikwh(x,y)}$.
From Stam's Paper about diffraction shader we know some paramters
for the length, width and height for a given sample patch, i.e. heightfield
h(x,y) and when using those parameters are able to find a explicit
number for $x_{max}$.

Facts we are using from Stam's Paper:

\begin{itemize}
\item Height of bump: 0.15micro meters
\item Width of a bump: 0.5micro meters
\item Length of a bump: 1micro meters
\item $k=\frac{2\pi}{\lambda}$ is the wavenumber and $\lambda\in[\lambda_{min,}\lambda_{max}]$its
wavelength hence $k_{max}=\frac{2\pi}{\lambda_{min}}$ 
\item $w$~is a component of the vector $\vec{v}=\vec{k_{1}}-\vec{k_{2}}=(u,v,w)$,
where $\vec{k_{1}}$ and $\vec{k_{2}}$ are \textbf{normalized} direction
vectors and this each component can have a value in range {[}-2, 2{]}.
\item for simplification, assume$[\lambda_{min,}\lambda_{max}]=[400nm,700nm].$
\end{itemize}

Hence $x_{max}=|i|*k_{max}*w_{max}*h_{max}=$$k_{max}*w_{max}*h_{max}=2*(\frac{2\pi}{4*10^{-7}m})*1.5*10^{-7}=1.5\pi$and
it follows for our intervall $I=[0,1.5\pi]$. Next we are going to
find the value for M. Since the exponential function is monoton growing
(on the interval I) and and the derivative of the \textbf{exp} function
is the exp function itself, we can find such an M: $M=e^{x_{max}}=exp(1.5\pi)$and
$|f^{(n+1)}(x)|\leq M$ holds. With $|E_{n}(x_{max})|\leq\frac{M}{(n+1)!}|x_{max}-a|^{n+1}=\frac{exp(1.5\pi)*(1.5\pi)^{n+1}}{(n+1)!}$we
now can find a value of n for a given bound, i.e. we can find an value
of $N\mathbb{\in N}$ s.t. $\frac{exp(1.5\pi)*(1.5\pi)^{N+1}}{(N+1)!}\leq\epsilon$.
With Octave/Matlab we can see: 
\begin{itemize}
\item if N=20 then $\epsilon\approx2.9950*10^{-4}$
\item if N=25 then $\epsilon\approx8.8150*10^{-8}$
\item if N=30 then $\epsilon\approx1.0050*10^{-11}$
\end{itemize}

\subsubsection{Conclusion}

With this approach we have that$\sum_{n=0}^{25}\frac{(ikwh)^{n}}{n!}\mathcal{F}\left\{ h{}^{n}\right\} (\alpha,\beta)$is
an approximation of P(u,v) with error$\epsilon\approx8.8150*10^{-8}$.
This means we can precompute 25 Fourier Transformations (for example
via FFT2) and then sum them up in order to approximate P(u,v) and
$\epsilon\approx8.8150*10^{-8}$. This approach will allow us to speed
up our shader. Furthermore we see that when we just take 5 more iterations,
we will reduce the error bound to the dimension of $10^{-11}$.

\textbf{NB}: More explanation about how the shader itself works during
our discussion.


\subsubsection{Sources}
\begin{itemize}
\item \textbf{{[}1{]}} http://en.wikipedia.org/wiki/Ratio\_test
\item \textbf{{[}2{]}} http://math.jasonbhill.com/courses/fall-2010-math-2300-005/lectures/taylor-polynomial-error-bounds\end{itemize}




\subsection{Our derivations}

EXPLAIN: Why do we want a formulation for $L_{\lambda}(w_r)$ in some words. what does it represent?

Definition of $BRDF(w_i, w_r) := f_r(w_i, w_r) = \frac{dL_r(w_r)}{dE_i(w_i)}=\frac{dL_r(w_r)}{L_i(w_i)cos(\theta_i)dw_i}$  
Hence, we can dervie the following expression:
\begin{align*}
f_r(w_i, w_r) = \frac{dL_r(w_r)}{L_i(w_i)cos(\theta_i)dw_i} \\
=> f_r(w_i, w_r) L_i(w_i)cos(\theta_i)dw_i = dL_r(w_r) \\
=> \int_{\Omega}f_r(w_i, w_r) L_i(w_i)cos(\theta_i)dw_i = \int_{\Omega}dL_r(w_r) \\
=> L_r(w_r) = \int_{\Omega}f_r(w_i, w_r) L_i(w_i)cos(\theta_i)dw_i
\end{align*}

We assume, that our incident light is a directional light source like sun-light and therefore its radiance is given as $L_{\lambda}(w)=I(\lambda)\delta(w-w_i)$ where $I(\lambda)$ is the intensity of the relative spectral power for the wavelength $\lambda$. Thus we get for our the brdf formulation:

\begin{align}
L_{\lambda}(w_r) 
& = \int_{\Omega} BRDF_{\lambda}(w_i, w_r) L_{\lambda}(w_i) cos(\theta_i) dw_i \\
& = BRDF_{\lambda}(w_i, w_r) I(\lambda) cos(\theta_i)
\end{align}

where $w_i$ is the solid angle for the incoming light, $\theta{_i}$ is the angle of incidence,
$w_r$ is the solid angle for the reflected light, $\lambda$ wavelength, $\Omega$ is the hemisphre we of integration for the incomming light.
Radiance reflected by given surface in given direction:
$L_{\lambda}(w_i)$ is the incomming radiance, $L_{\lambda}(w_r)$ is the reflected radiance

For the $BRDF(w_i, w_r)$ we are going to use the formulation dervied by Stam described above which looks like this using the fact that wavenumber $k=\frac{2\pi}{\lambda}$:

\begin{align*}
BRDF(w_i, w_r) 
& = \frac{k^2 F^2 G}{4\pi^2 A w^2} \langle \left|P(ku, kv) \right|^2\rangle \\
& = \frac{k^2 F^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})}{cos(\theta_1)cos(\theta_2) 4\pi^2 A w^2} \langle \left|P(ku, kv)  \right|^2\rangle \\
& = \frac{4 \pi^2 F^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})}{cos(\theta_1)cos(\theta_2) 4\pi^2 A \lambda^2 w^2} \langle \left|P(ku, kv)  \right|^2\rangle \\
& = \frac{F(w_i, w_r)^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})}{cos(\theta_1)cos(\theta_2) A \lambda^2 w^2} \langle \left|P(ku, kv)  \right|^2\rangle
\end{align*}

where $\hat{\mathbf{k_t}}$ represents a unit vector whose spherical coordinates are given by the solid angle $t$.
Since we are going to integrate over a sphere $\Omega$ we can write the component $w=(cos(\theta_i)+cos(\theta_r))$
SHOW WHY WE ARE ALLOWED TO WRITE IT LIKE THIS => SPHERICAL COORDINATES DIFFERENCE $(k1 - k2) = (u,v,w)$ and so on.
this our identity for $L_{r}(w_r)$ will lead us to the following identiy using our identity :

\begin{align*}
L_{\lambda}(w_r) 
& = \frac{F(w_i, w_r)^2 (1-\hat{\mathbf{k_1}}\cdot\hat{ \mathbf{k_2}})^2}{A \lambda^2 cos(\theta_i)cos(\theta_r)  (cos(\theta_i)+cos(\theta_r))^2} \langle \left|P_{cont}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})  \right|^2\rangle cos(\theta_i) I(\lambda) \\
& = I(\lambda) \frac{F(w_i, w_r)^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{\lambda^2 A (cos(\theta_i)+cos(\theta_r))^2 cos(\theta_r)} \langle \left|P_{cont}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})  \right|^2\rangle \\
& = I(\lambda) \frac{F(w_i, w_r)^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{\lambda^2 A (cos(\theta_i)+cos(\theta_r))^2 cos(\theta_r)} \langle \left|T_0^2 P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})  \right|^2\rangle
\end{align*}

$P_{cont}$ is the continious inverse Fourier transform for the taylor seies of our hight-field representing the nano structure, i.e. $P(k,l) = \mathcal{F}^{-1}\{p\}(k,l)$ and $P_{dtft}$ is the dicrete-time inverse Fourier Transform for the same problem domain and $T_0$ the sampling distance for the discretization pf $p(x,y)$ assuming equal and uniform sampling in both dimensions $x,y$.

\subsection{Relative BRDF}
reason why relative brdf: In order to scale the reflactiance such that we are able to texture. 
convex combination reflectance with texture. Scale illumination.

Let us examine what $L_\lambda(w_r)$ will be for $w_r = w_0 := (0,0,*)$ i.e. specular reflection case, denoted as $L_\lambda^{spec}(w_0)$. 
When we know the expression for $L_\lambda^{spec}(w_0)$ we would be able to compute the relative reflected radiance for our problem by simply dividing $L_\lambda(w_r)$ by $L_\lambda^{spec}(w_0)$, denoted as 

\begin{equation}
    \rho_\lambda(w_i,w_r) = \frac{L_\lambda(w_r)}{L_\lambda^{spec}(w_0)}
\end{equation}

But first, let us derive the following expression:

\begin{align*}
L_\lambda^{spec}(w_0) 
& = I(\lambda) \frac{F(w_0, w_0)^2 (1-\colvec[0]{0}{1}\cdot\colvec[0]{0}{-1})^2}{\lambda^2 A (cos(0)+cos(0))^2 cos(0)} \langle \left|T_0^2 P_{dtft}(0,0)  \right|^2\rangle \\
& = I(\lambda) \frac{F(w_0, w_0)^2 (1+1)^2}{\lambda^2 A (1+1)^2 1}\left| T_0^2 N_{sample} \right|^2 \\
& = I(\lambda) \frac{F(w_0, w_0)^2}{\lambda^2 A}\left| T_0^2 N_{sample} \right|^2 
\end{align*}

Where $N_{samples}$ is the number of samples of the dtft.

Thus, we can plug our last derived expression into the definition for the relative reflectance radiance in the direction $w_r$ and will get:

\begin{align*}
\rho_\lambda(w_i,w_r)
& = \frac{L_\lambda(w_r)}{L_\lambda^{spec}(w_0)} \\
& = \frac{I(\lambda) \frac{F(w_i, w_r)^2 (1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{\lambda^2 A (cos(\theta_i)+cos(\theta_r))^2 cos(\theta_r)} \langle \left|T_0^2 P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})  \right|^2\rangle}{I(\lambda) \frac{F(w_0, w_0)^2}{\lambda^2 A}\left| T_0^2 N_{sample} \right|^2 } \\
& = \frac{F^2(w_i,w_r)(1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{F^2(w_0,w_0)(cos(\theta_i)+cos(\theta_r))^2 cos(\theta_r)}  \langle \left|\frac{P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})}{N_{samples}}\right|^2\rangle
\end{align*}

for simplification and a better overview, let us introduce the following expression, the so called gain factor

\begin{equation}
    C(w_i,w_r) = \frac{F^2(w_i,w_r)(1-\hat{\mathbf{k_1}}\cdot\hat{\mathbf{k_2}})^2}{F^2(w_0,w_0)(cos(\theta_i)+cos(\theta_r))^2 cos(\theta_r) N_{samples}^2}
\end{equation}

Using this substitute, we will end up with the following expression for the relative reflectance radiance

\begin{equation}
\rho_\lambda(w_i,w_r) =  C(w_i,w_r) \langle \left|P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2\rangle
\end{equation}

using the previous definition for the relative reflectance radiance $\rho_\lambda(w_i,w_r) = \frac{L_\lambda(w_r)}{L_\lambda^{spec}(w_0)}$ which we can rearrange to the expression 

\begin{equation}
L_\lambda(w_r) = \rho_\lambda(w_i,w_r)L_\lambda^{spec}(w_0)
\end{equation}

Let us choose $L_\lambda^{spec}(w_0) = S(\lambda)$ such that is has the same pforifle as the relative spectral power distribuation of CIE Standard Illuminant $D65$. Further, when integration over $\lambda$ for a specular surface we should get $CIE_XYZ$ values corresponding to the white point for $D65$ 

the corresponding tristimulus values using CIE colormatching functions for the $CIE_XYZ$ values look like:

SEE HOW THIS DEFINITION DIFFERS FROM THE WIKIDEF AND HOW WE COULD END UP WITH A SIMILAR DEFINITION.

\begin{equation}
X = \int_{\lambda}L_\lambda(w_r)\overline{x}(\lambda)d\lambda
\end{equation} 

\begin{equation}
Y = \int_{\lambda}L_\lambda(w_r)\overline{y}(\lambda)d\lambda
\end{equation}

\begin{equation}
Z = \int_{\lambda}L_\lambda(w_r)\overline{z}(\lambda)d\lambda
\end{equation}

where $\overline{x}$, $\overline{y}$, $\overline{z}$ are the color matching functions

Using our last finding for $L_\lambda(w_r)$ and the definition for the tristimulus values we can actually derive an expression for computing the colors for our brdf model. Since X, Y, Z are defined similarly, it satisfies to derive an explicit expression for just one tristimulus term, for example X. The other two will look the same, except the we have to replace all X with Y or Z respectively. Therefore, we get:

\begin{align*}
X 
& =\int_{\lambda}L_\lambda(w_r)\overline{x}(\lambda)d\lambda \\
& =\int_{\lambda}\rho_\lambda(w_i,w_r)L_\lambda^{spec}(w_0) \overline{x}(\lambda)d\lambda \\
& =\int_{\lambda}\rho_\lambda(w_i,w_r) S(\lambda) \overline{x}(\lambda)d\lambda \\
& =\int_{\lambda} C(w_i,w_r) \langle \left|P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2\rangle S(\lambda) \overline{x}(\lambda)d\lambda \\
& = C(w_i,w_r) \int_{\lambda} \langle \left|P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2\rangle S(\lambda) \overline{x}(\lambda)d\lambda \\
& = C(w_i,w_r) \int_{\lambda} \langle \left|P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2\rangle S_x(\lambda)d\lambda
\end{align*}

Where we used the definition $S_x(\lambda)\overline{x}(\lambda)$ in the last step.

\subsection{Taylour approximation for BRDF}
Using $P_{dtft} = \mathcal{F}^{-1}\{p\}(u,v)$ definied in the section of the taylor approximationwe get for the tristumulus value X, we will get:

\begin{align*}
X 
& = C(w_i,w_r) \int_{\lambda} \langle \left|P_{dtft}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2\rangle S_x(\lambda)d\lambda \\
& = C(w_i,w_r) \int_{\lambda} \left| \sum_{n=0}^N \frac{(wk)^n}{n!} \mathcal{F}^{-1}\{i^n h^n\}(\frac{2\pi u}{\lambda}, \frac{2\pi v}{\lambda})\right|^2 S_x(\lambda)d\lambda
\end{align*}


\subsection{Sampling: Gaussian Window}


Let $window_g$ denote the gaussian window with $4\sigma_s$ $\mu m$ where $\sigma_f = \frac{1}{2\pi\sigma_s}$
let us further substitute $\mathbf{t(x,y)}=i^n h(x,y)^n$

\begin{equation}
\mathcal{F}_{dtft}^{-1}\{\mathbf{t}\}(u,v) = \mathcal{F}_{fft}^{-1}\{\mathbf{t}\}(u,v)window_g(\sigma_f)
\end{equation} 

Therefore we can deduce the following expression from this:

\begin{align*}
\mathcal{F}_{dtft}^{-1}\{\mathbf{t}\}(u,v)
& = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} {F}_{fft}^{-1}\{\mathbf{t}\}(w_u,w_v) \phi(u-w_u, v-w_v) dw_u dw_v \\
& = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \sum_i \sum_j {F}_{fft}^{-1}\{\mathbf{t}\}(w_u,w_v) \delta(w_u-w_i, w_v-w_j)\phi(u-w_u, v-w_v) dw_u dw_v \\
& = \sum_i \sum_j \int_{-\infty}^{\infty} \int_{-\infty}^{\infty}  {F}_{fft}^{-1}\{\mathbf{t}\}(w_u,w_v) \delta(w_u-w_i, w_v-w_j)\phi(u-w_u, v-w_v) dw_u dw_v \\
& = \sum_i \sum_j {F}_{fft}^{-1}\{\mathbf{t}\}(w_u,w_v) \phi(u-w_u, v-w_v)
\end{align*}

where $\phi(x,y) = \pi e^{-\frac{x^2 + y^2}{2\sigma_{f}^2}}$

\subsection{Aplitude smooting}
Let us consider the so called 1-dimensional Box-function with length $T$ which is defined as the following: 
ADD AN IMAGE OF BOXFUNCTION

$
Box(x) =
\left\{
	\begin{array}{ll}
		1  & \mbox{if } x \leq T \\
		0 & \mbox{if } else
	\end{array}
\right.
$

We assume, that our given heighfield can be represented as a 2-dimensional box-function. 
Note that we can use any explicit given constrainted 2-dimensional function and will get some identities like
we get from the box-function.
 
Further we are assuming that we can model the overall surface be assuming this heighfield being distributed in a periodic manor.
Therfore, the whole surface can be represented like this $f(x) = \sum_{n=0}^{N} Box(x+nT_1, y+mT_2)$ assuming the given heighfield has the dimensions $T_1$ by $T_2$. But let us first consider the 1-dimensional Box-function case before deriving an identity for the Fourier transform of our 2-dimensional Box-function, i.e. the fourier transform of our heighfield. 

Note: A function $f$ periodic with periode $T$ means: $\forall x \in \mathcal{R}: Box(x) = Box(x+T)$

A so called bump can be represented by our 1-dimensional Box-function. We assume periodicity which is equaivalent to:   
$f(x) = \sum_{n=0}^{N} Box(x+nT)$

We are insterested in the 1-dimensional inverse Fourier transform of the 1-dimensional Box-function:

\begin{align*}
\mathcal{F}^{-1}\{f\}(w)
& =\int f(x) e^{iwx}dx\\
& =\int_{-\infty}^{\infty} \sum_{n=0}^{N} Box(x+nT) e^{iwx}dx\\
& =\sum_{n=0}^{N} \int_{-\infty}^{\infty} Box(x+nT) e^{iwx}dx
\end{align*}

Next, apply the following substituation $x+nT = y$ which will lead us to:

\begin{gather*}
x=y-nT\\
dx=dy
\end{gather*} 

Plugging this substituation back to the equation from above we will get 

\begin{align*}
\mathcal{F}^{-1}\{f\}(w)
& =\int f(x) e^{iwx}dx\\
& =\sum_{n=0}^{N} \int_{-\infty}^{\infty} Box(y) e^{iw(y-nT)}dy \\
& =\sum_{n=0}^{N} e^{-iwnT} \int_{-\infty}^{\infty} Box(y) e^{iwy}dy \\
& =\sum_{n=0}^{N} e^{-iwnT} \mathcal{F}\{f\}(w) \\
& =\mathcal{F}^{-1}\{f\}(w) \sum_{n=0}^{N} e^{-iwnT}  
\end{align*}

We used the fact that the term $e^{-iwnT}$ is a constant when integrating along $dy$ and the identity for the inverse Fourier transform of the Box function. Next, let us consider $\sum_{n=0}^N e^{-uwnT}$ further:

\begin{align*}
\sum_{n=0}^N e^{-uwnT}
& =\sum_{n=0}^N (e^{-uwT})^n \\
& =\frac{1-e^{iwT(N+1)}}{1-e^{-iwT}}
\end{align*}

We recognize the geometric series identity for the left-handside of this equation. Since our series is bounded we can derive our right-handside.

Since $e^{-ix}$ is a complex number and every complex number can be written in its polar form, i.e. $e^{-ix} = cos(x) + i sin(x)$ we can go even further, using the trigonometric idententities that $cos(-x) = cos(x)$ and $sin(-x) = -sin(x)$:

\begin{align*}
\frac{1-e^{iwT(N+1)}}{1-e^{-iwT}}
& =\frac{1-cos(wT(N+1)) + i sin(wT(N+1)) }{1-cos(wT) + i sin(wT)}
\end{align*}

Which is still a complex number $(p+iq)$. Every complex number can be written as a fraction of two complex numbers. This means that the complex number $(p+iq)$ can be written as $(p+iq) = \frac{(a+ib)}{(c+id)}$ for any $(a+ib), (c+id) \neq 0$. 
For our case, let us use the follwoing substituations: 

\begin{align}
a& := 1 - cos(wT(N+1))&
b& =sin(wT(N+1))\\
c& =1-cos(wT)&
d& =sin(wT)
\end{align}

hence it follows $\frac{1-e^{iwT(N+1)}}{1-e^{-iwT}} = \frac{(a+ib)}{(c+id)}$.
By rearanging the terms it follows $(a+ib) = (c+id)(p+iq)$ and multiplying the right handside out we get the follwing system of equations:

\begin{align}
(cp-dq)& =a\\
(dp + cq)& =b
\end{align}

Which gives lead us we some further math (trick: mult first eq. by $c$ and 2nd by $d$, then adding them together. using distributivity and we have the identity for p for example, similar for q) to 

\begin{align}
p& =\frac{(ac+bd)}{c^2 + d^2}\\
q& =\frac{(bc+ad)}{c^2 + d^2}
\end{align}


Putting our substituation for $a, b, c, d$ back into the current representatio for $p$ and $q$ and using some trigonometric identites, this we then get:

\begin{align}
p& =\frac{1}{2}+\frac{1}{2}\left(\frac{cos(wTN)-cos(wT(N+1))}{1-cos(wT)}\right)\\
q& =\frac{sin(wT(N+1))-sin(wTN)-sin(wT)}{2(1-cos(wT))}
\end{align}

Since we have seen, that $\sum_{n=0}^N e^{-uwnT}$ is a complex number and can be written as $(p+iq)$ and we know now the explicit identity for those $p$ and $q$ we get for the 1-dimensional Fourier transform of the 1-dimensional Box-function the following final identity:

\begin{align*}
\mathcal{F}^{-1}\{f\}(w)
& =\mathcal{F}^{-1}\{f\}(w) \sum_{n=0}^{N} e^{-iwnT} \\
& = (p+iq) \mathcal{F}^{-1}\{Box\}(w)  
\end{align*}

In oder to derive next a identity for the Fourier transform for our 2-dim heighfield, we can proceed similarly, the only fact which changes is, that we are now in a 2-dimensional domain, i.e. we are about to compute a two-dimensional Fourier transform:
Let us again us again a Box-function, this time a 2-dimensional Box-function $Box(x,y)$ just for the sake of convenience.

\begin{align*}
\mathcal{F}^{-1}\{f\}(w_1,w_2)
& = \int_{-\infty}^{\infty}\int_{-\infty}^{\infty} \sum_{n_2=0}^{N_1} \sum_{n_2=0}^{N_2} Box(x_1 + n_1 T_1, x_2 + n_2 T_2) e^{iw(x_1 + x_2)}dx_1 dx_2 \\
& = \int_{-\infty}^{\infty}\int_{-\infty}^{\infty} \sum_{n_2=0}^{N_1} \sum_{n_2=0}^{N_2} Box(y_1, y_2) e^{iw((y_1 - n_1 T_1) + (y_2 + n_2 T_2))}dx_1 dx_2 \\
& =\sum_{n_2=0}^{N_1} \sum_{n_2=0}^{N_2} \int_{-\infty}^{\infty}\int_{-\infty}^{\infty} Box(y_1, y_2) e^{iw(y_1 + y_2)} e^{-iw(n_1 T_1 + n_2 T_2)}dy_1 dy_2 \\
& =\sum_{n_2=0}^{N_1} \sum_{n_2=0}^{N_2} e^{-iw(n_1 T_1 + n_2 T_2)} \int_{-\infty}^{\infty}\int_{-\infty}^{\infty} Box(y_1, y_2) e^{iw(y_1 + y_2)} dy_1 dy_2 \\
& =\left(\sum_{n_2=0}^{N_1} \sum_{n_2=0}^{N_2} e^{-iw(n_1 T_1 + n_2 T_2)}\right) \mathcal{F}^{-1}\{Box\}(w_1,w_2) \\
& =\left(\sum_{n_2=0}^{N_1} e^{-iw n_1 T_1}\right) \left(\sum_{n_2=0}^{N_2} e^{-iw n_2 T_2}\right) \mathcal{F}^{-1}\{Box\}(w_1,w_2) \\
& =(p_1 + i q_1)(p_2 + i q_2) \mathcal{F}^{-1}\{Box\}(w_1,w_2) \\
& =((p_1 p_2 - q_1 q_2) + i(p_1 p_2 + q_1 q_2)) \mathcal{F}^{-1}\{Box\}(w_1,w_2) \\
& =(p + iq) \mathcal{F}^{-1}\{Box\}(w_1,w_2)
\end{align*}

Where we define $p := (p_1 p_2 - q_1 q_2) $ and $q := (p_1 p_2 + q_1 q_2)$. For this identity we used green's integration rule which allowed us to split the double integral to the product of two single integrations. Also, we used the definition of the 2-dimensional inverse Fourer transform of the Box-function. We applied the same substituation like we did in for the 1 dimensional case, but this time twice, once for each variable seperately. The last step, substituting with $p$ and $q$ will be useful later in the implementation. The insight should be, that the product of two complex numbers is again a complex number. We will have to compute the absolute value of $\mathcal{F}^{-1}\{f\}(w_1,w_2)$ which will then be equal $(p^2 + q^2)^{\frac{1}{2}}\left|\mathcal{F}^{-1}\{Box\}(w_1,w_2)\right|$

\subsection{Final Expression}
As the last step of our series of derivations, we plug all our findings together to one big equation in order to compute the colors in the $CIE_XYZ$ colorspace:

For a given heigh-field $h(x,y)$, representing a small patch of the nano-structure of our surface, the resulting CIE_XYZ caused by the effect of diffraction can be computed like the following: 

\begin{equation}
\begin{split}
\colvec[X]{X}{Z}& = C(w_i,w_r) \int_{\lambda} \sum_r \sum_s (p(r,s;T)^2 + q(r,s;T)^2)^{\frac{1}{2}} \\
& \quad \sum_{n=0}^N  \frac{(wk)^n}{n!} \left| {F}_{fft}^{-1}\{i^n h^n\}(\frac{2\pi u}{\lambda},\frac{2\pi v}{\lambda})\right|^2 \phi(u-w_r, v-w_s) \colvec[S_x(\lambda)]{S_y(\lambda)}{S_z(\lambda)}d\lambda
\end{split}
\end{equation}

where $(p(r,s;T)^2 + q(r,s;T)^2)^{\frac{1}{2}}$ represents the phaser, $\phi(x,y) = \pi e^{-\frac{x^2 + y^2}{2\sigma_{f}^2}}$ is the gaussian window, $\colvec[S_x(\lambda)]{S_y(\lambda)}{S_z(\lambda)}$.

